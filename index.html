<!doctype html>
<head><meta charset="utf-8"><title>Zones</title><script type="application/json" id="menu-search-biblio">[{"type":"clause","id":"sec-zone-objects","aoid":null,"title":"Zone Objects","number":"1","namespace":"https://domenic.github.io/zones/","location":"","key":"Zone Objects"},{"type":"clause","id":"sec-zone-abstract-operations","aoid":null,"title":"Zone Abstract Operations","number":"1.1","namespace":"https://domenic.github.io/zones/","location":"","key":"Zone Abstract Operations"},{"type":"clause","id":"sec-zone-constructor","aoid":null,"title":"The Zone Constructor","number":"1.2","namespace":"https://domenic.github.io/zones/","location":"","key":"The Zone Constructor"},{"type":"clause","id":"sec-zone","aoid":null,"title":"Zone ( _options_ )","number":"1.2.1","namespace":"https://domenic.github.io/zones/","location":"","key":"Zone ( _options_ )"},{"type":"clause","id":"sec-properties-of-the-zone-constructor","aoid":null,"title":"Properties of the Zone Constructor","number":"1.3","namespace":"https://domenic.github.io/zones/","location":"","key":"Properties of the Zone Constructor"},{"type":"clause","id":"set-get-zone.current","aoid":null,"title":"get Zone.current","number":"1.3.1","namespace":"https://domenic.github.io/zones/","location":"","key":"get Zone.current"},{"type":"clause","id":"sec-properties-of-the-zone-prototype-object","aoid":null,"title":"Properties of the Zone Prototype Object","number":"1.4","namespace":"https://domenic.github.io/zones/","location":"","key":"Properties of the Zone Prototype Object"},{"type":"clause","id":"sec-get-zone.prototype.parent","aoid":null,"title":"get Zone.prototype.parent","number":"1.4.1","namespace":"https://domenic.github.io/zones/","location":"","key":"get Zone.prototype.parent"},{"type":"clause","id":"sec-zone.prototype.fork","aoid":null,"title":"Zone.prototype.fork ( _options_ )","number":"1.4.2","namespace":"https://domenic.github.io/zones/","location":"","key":"Zone.prototype.fork ( _options_ )"},{"type":"clause","id":"sec-zone.prototype.run","aoid":null,"title":"Zone.prototype.run ( _callback_ )","number":"1.4.3","namespace":"https://domenic.github.io/zones/","location":"","key":"Zone.prototype.run ( _callback_ )"},{"type":"clause","id":"sec-zone.prototype.wrap","aoid":null,"title":"Zone.prototype.wrap ( _callback_ )","number":"1.4.4","namespace":"https://domenic.github.io/zones/","location":"","key":"Zone.prototype.wrap ( _callback_ )"},{"type":"clause","id":"sec-properties-of-zone-instances","aoid":null,"title":"Properties of Zone Instances","number":"1.5","namespace":"https://domenic.github.io/zones/","location":"","key":"Properties of Zone Instances"},{"type":"clause","id":"sec-properties-of-zone-instances-name","aoid":null,"title":"name","number":"1.5.1","namespace":"https://domenic.github.io/zones/","location":"","key":"name"},{"type":"clause","id":"monkeypatch-promises","aoid":null,"title":"Revisions to Promise Objects","number":"2","namespace":"https://domenic.github.io/zones/","location":"","key":"Revisions to Promise Objects"},{"type":"clause","id":"monkeypatch-promisereaction-records","aoid":null,"title":"PromiseReaction Records","number":"2.1","namespace":"https://domenic.github.io/zones/","location":"","key":"PromiseReaction Records"},{"type":"clause","id":"monkeypatch-perform-promise-then","aoid":null,"title":"PerformPromiseThen","number":"2.2","namespace":"https://domenic.github.io/zones/","location":"","key":"PerformPromiseThen"},{"type":"clause","id":"monkeypatch-promisereactionjob","aoid":null,"title":"PromiseReactionJob","number":"2.3","namespace":"https://domenic.github.io/zones/","location":"","key":"PromiseReactionJob"},{"type":"table","id":"table-zone-constructor-slots","number":1,"caption":"Table 1: Internal Slots of the Zone Constructor","namespace":"https://domenic.github.io/zones/","location":"","key":"Table 1: Internal Slots of the Zone Constructor"},{"type":"table","id":"table-zone-slots","number":2,"caption":"Table 2: Internal Slots of Zone Instances","namespace":"https://domenic.github.io/zones/","location":"","key":"Table 2: Internal Slots of Zone Instances"},{"type":"term","term":"%Zone%","refId":"sec-zone-constructor","namespace":"https://domenic.github.io/zones/","location":"","key":"%Zone%"},{"type":"term","term":"%ZonePrototype%","refId":"sec-properties-of-the-zone-prototype-object","namespace":"https://domenic.github.io/zones/","location":"","key":"%ZonePrototype%"}]</script></head><body><div id="menu-toggle">☰</div><div id="menu"><div id="menu-search"><input type="text" id="menu-search-box" placeholder="Search..."><div id="menu-search-results" class="inactive"></div></div><div id="menu-toc"><ol class="toc"><li><span class="item-toggle">◢</span><a href="#sec-zone-objects" title="Zone Objects"><span class="secnum">1</span> Zone Objects</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-zone-abstract-operations" title="Zone Abstract Operations"><span class="secnum">1.1</span> Zone Abstract Operations</a></li><li><span class="item-toggle">◢</span><a href="#sec-zone-constructor" title="The Zone Constructor"><span class="secnum">1.2</span> The Zone Constructor</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-zone" title="Zone ( _options_ )"><span class="secnum">1.2.1</span> Zone ( <var>options</var> )</a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-properties-of-the-zone-constructor" title="Properties of the Zone Constructor"><span class="secnum">1.3</span> Properties of the Zone Constructor</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#set-get-zone.current" title="get Zone.current"><span class="secnum">1.3.1</span> get Zone.current</a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-properties-of-the-zone-prototype-object" title="Properties of the Zone Prototype Object"><span class="secnum">1.4</span> Properties of the Zone Prototype Object</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-get-zone.prototype.parent" title="get Zone.prototype.parent"><span class="secnum">1.4.1</span> get Zone.prototype.parent</a></li><li><span class="item-toggle-none"></span><a href="#sec-zone.prototype.fork" title="Zone.prototype.fork ( _options_ )"><span class="secnum">1.4.2</span> Zone.prototype.fork ( <var>options</var> )</a></li><li><span class="item-toggle-none"></span><a href="#sec-zone.prototype.run" title="Zone.prototype.run ( _callback_ )"><span class="secnum">1.4.3</span> Zone.prototype.run ( <var>callback</var> )</a></li><li><span class="item-toggle-none"></span><a href="#sec-zone.prototype.wrap" title="Zone.prototype.wrap ( _callback_ )"><span class="secnum">1.4.4</span> Zone.prototype.wrap ( <var>callback</var> )</a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-properties-of-zone-instances" title="Properties of Zone Instances"><span class="secnum">1.5</span> Properties of Zone Instances</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-properties-of-zone-instances-name" title="name"><span class="secnum">1.5.1</span> name</a></li></ol></li></ol></li><li><span class="item-toggle">◢</span><a href="#monkeypatch-promises" title="Revisions to Promise Objects"><span class="secnum">2</span> Revisions to Promise Objects</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#monkeypatch-promisereaction-records" title="PromiseReaction Records"><span class="secnum">2.1</span> PromiseReaction Records</a></li><li><span class="item-toggle-none"></span><a href="#monkeypatch-perform-promise-then" title="PerformPromiseThen"><span class="secnum">2.2</span> PerformPromiseThen</a></li><li><span class="item-toggle-none"></span><a href="#monkeypatch-promisereactionjob" title="PromiseReactionJob"><span class="secnum">2.3</span> PromiseReactionJob</a></li></ol></li></ol></div></div><h1 class="version">Stage 0 Draft / March 16, 2016</h1><h1 class="title">Zones</h1>
<script src="https://bterlson.github.io/ecmarkup/ecmarkup.js" defer=""></script>
<link rel="stylesheet" href="https://bterlson.github.io/ecmarkup/elements.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_light.min.css">

<emu-clause id="sec-zone-objects">
  <h1><span class="secnum">1</span>Zone Objects<span class="utils"><span class="anchor"><a href="#sec-zone-objects">#</a></span></span></h1>

  <p>A Zone is an object that represents a logical asynchronous context.</p>

  <emu-clause id="sec-zone-abstract-operations">
    <h1><span class="secnum">1.1</span>Zone Abstract Operations<span class="utils"><span class="anchor"><a href="#sec-zone-abstract-operations">#</a></span></span></h1>

    <p>None yet... Will probably want to refactor some out in order to make them more accessible to other specifications.</p>
  </emu-clause>

  <emu-clause id="sec-zone-constructor">
    <h1><span class="secnum">1.2</span>The Zone Constructor<span class="utils"><span class="anchor"><a href="#sec-zone-constructor">#</a></span></span></h1>

    <p>The Zone constructor is the  <dfn>%Zone%</dfn> intrinsic object and the initial value of the <code>Zone</code> property of the <emu-xref href="#global-object"><a href="https://tc39.github.io/ecma262/#global-object">global object</a></emu-xref>. When called as a constructor it creates and initializes a new Zone object. <code>Zone</code> is not intended to be called as a function and will throw an exception when called in that manner.</p>

    <p>The <code>Zone</code> constructor is designed to be subclassable. It may be used as the value in an <code>extends</code> clause of a class definition. Subclass constructors that intend to inherit the specified <code>Zone</code> behaviour must include a <code>super</code> call to the <code>Zone</code> constructor to create and initialize the subclass instance with the internal state necessary to support the <code>Zone</code> and <code>Zone.prototype</code> built-in methods.</p>

    <emu-note><span class="note">Note</span>
      <p>(Spec review note) I'm not sure if you can subclass classes that have internal slots on their constructors. Which is fine with me; just would need to revise the above. Might also want to make some things not go through <code>.constructor</code> in that case, and perhaps prohibit subclassing by checking NewTarget.</p>
    </emu-note>

    <emu-clause id="sec-zone">
      <h1><span class="secnum">1.2.1</span>Zone ( <var>options</var> )<span class="utils"><span class="anchor"><a href="#sec-zone">#</a></span></span></h1>

      <p>When the <code>Zone</code> function is called with argument <var>options</var>, the following steps are taken:</p>

      <emu-alg><ol><li>If NewTarget is <emu-val>undefined</emu-val>, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>name</var> be <code>"(unnamed zone)"</code>.</li><li>Let <var>parent</var> be <emu-val>null</emu-val>.</li><li>If <var>options</var> is <emu-val>undefined</emu-val>, set <var>options</var> to ! <emu-xref aoid="ObjectCreate"><a href="https://tc39.github.io/ecma262/#sec-objectcreate">ObjectCreate</a></emu-xref>(<emu-xref href="#sec-properties-of-the-object-prototype-object"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-object-prototype-object">%ObjectPrototype%</a></emu-xref>).</li><li>Perform ? <emu-xref aoid="RequireObjectCoercible"><a href="https://tc39.github.io/ecma262/#sec-requireobjectcoercible">RequireObjectCoercible</a></emu-xref>(<var>options</var>).</li><li>Let <var>nameOption</var> be ? <emu-xref aoid="GetV"><a href="https://tc39.github.io/ecma262/#sec-getv">GetV</a></emu-xref>(<var>options</var>, <code>"name"</code>).</li><li>If <var>nameOption</var> is not <emu-val>undefined</emu-val>, set <var>name</var> to ? <emu-xref aoid="ToString"><a href="https://tc39.github.io/ecma262/#sec-tostring">ToString</a></emu-xref>(<var>nameOption</var>).</li><li>Let <var>parentOption</var> be ? <emu-xref aoid="GetV"><a href="https://tc39.github.io/ecma262/#sec-getv">GetV</a></emu-xref>(<var>options</var>, <code>"parent"</code>).</li><li>If <var>parentOption</var> is not <emu-val>undefined</emu-val>, set <var>parent</var> to <var>parentOption</var>.</li><li>If <var>parent</var> is not <emu-val>null</emu-val> and does not have a [[ParentZone]] internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>zone</var> be ? <emu-xref aoid="OrdinaryCreateFromConstructor"><a href="https://tc39.github.io/ecma262/#sec-ordinarycreatefromconstructor">OrdinaryCreateFromConstructor</a></emu-xref>(NewTarget, <code>"%ZonePrototype"</code>, « [[ParentZone]] »).</li><li>Set <var>zone</var>'s [[ParentZone]] internal slot to <var>parent</var>.</li><li>Perform ! <emu-xref aoid="DefinePropertyOrThrow"><a href="https://tc39.github.io/ecma262/#sec-definepropertyorthrow">DefinePropertyOrThrow</a></emu-xref>(<var>zone</var>, <code>"name"</code>, PropertyDescriptor {[[Value]]: <var>name</var>, [[Writable]]: <emu-val>false</emu-val>, [[Enumerable]]: <emu-val>false</emu-val>, [[Configurable]]: true }).</li><li>Return <var>zone</var>.
      </li></ol></emu-alg>

      <emu-note><span class="note">Note 1</span>
        <p>The <code>Zone</code> constructor is not typically used directly. Instead, <code>anotherZone.fork({ name })</code> is used to create a new zone that is the child of an existing one. A particular common pattern is <code>Zone.current.fork({ name })</code>.</p>
      </emu-note>

      <emu-note><span class="note">Note 2</span>
        <p>(Spec review note) This is intended to mimic the signature <code>constructor({ name = "(unnamed zone)", parent = null } = {}) { ... }</code>.</p>
      </emu-note>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-the-zone-constructor">
    <h1><span class="secnum">1.3</span>Properties of the Zone Constructor<span class="utils"><span class="anchor"><a href="#sec-properties-of-the-zone-constructor">#</a></span></span></h1>

    <p>The value of the [[Prototype]] internal slot of the <code>Zone</code> constructor is the intrinsic object <emu-xref href="#sec-properties-of-the-function-constructor"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-function-constructor">%FunctionPrototype%</a></emu-xref>. The <code>Zone</code> constructor is initially created with the internal slots described in  <emu-xref href="#table-zone-constructor-slots"><a href="#table-zone-constructor-slots">Table 1</a></emu-xref>.</p>

    <emu-table id="table-zone-constructor-slots" caption="Internal Slots of the Zone Constructor"><figure><figcaption>Table 1: Internal Slots of the Zone Constructor</figcaption>
      <table>
        <thead>
          <tr>
            <th>Internal Slot</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>[[CurrentZone]]</td>
            <td>A <code>Zone</code> object representing the current zone.</td>
          </tr>
        </tbody>
      </table>
    </figure></emu-table>

    <p>At <emu-xref href="#realm"><a href="https://tc39.github.io/ecma262/#realm">realm</a></emu-xref> initialization time, the following steps must be run to set up the <code>Zone</code> constructor's internal slots:</p>

    <emu-alg><ol><li>Let <var>options</var> be ! <emu-xref aoid="ObjectCreate"><a href="https://tc39.github.io/ecma262/#sec-objectcreate">ObjectCreate</a></emu-xref>(<emu-xref href="#sec-properties-of-the-object-prototype-object"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-object-prototype-object">%ObjectPrototype%</a></emu-xref>).</li><li>Perform ! <emu-xref aoid="CreateDataProperty"><a href="https://tc39.github.io/ecma262/#sec-createdataproperty">CreateDataProperty</a></emu-xref>(<var>options</var>, <code>"name"</code>, <code>"(root zone)"</code>).</li><li>Set the value of <emu-xref href="#sec-zone-constructor"><a href="#sec-zone-constructor">%Zone%</a></emu-xref>'s [[CurrentZone]] internal slot to ! <emu-xref aoid="Construct"><a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a></emu-xref>(<emu-xref href="#sec-zone-constructor"><a href="#sec-zone-constructor">%Zone%</a></emu-xref>, « <var>options</var> »).
    </li></ol></emu-alg>

    <emu-clause id="set-get-zone.current">
      <h1><span class="secnum">1.3.1</span>get Zone.current<span class="utils"><span class="anchor"><a href="#set-get-zone.current">#</a></span></span></h1>

      <p><code>Zone.current</code> is an accessor property whose set accessor function is <emu-val>undefined</emu-val>. Its get accessor function performs the following steps:</p>

      <emu-alg><ol><li>Let <var>Z</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>Z</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <var>Z</var> does not have a [[CurrentZone]] internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>Return the value of <var>Z</var>'s [[CurrentZone]] internal slot.
      </li></ol></emu-alg>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-the-zone-prototype-object">
    <h1><span class="secnum">1.4</span>Properties of the Zone Prototype Object<span class="utils"><span class="anchor"><a href="#sec-properties-of-the-zone-prototype-object">#</a></span></span></h1>

    <p>The Zone prototype object is the intrinsic object  <dfn>%ZonePrototype%</dfn>. The value of the [[Prototype]] internal slot of the Zone prototype object is the intrinsic object <emu-xref href="#sec-properties-of-the-object-prototype-object"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-object-prototype-object">%ObjectPrototype%</a></emu-xref>. The Zone prototype object is an ordinary object. It does not have any of the internal slots of Zone instances.</p>

    <emu-clause id="sec-get-zone.prototype.parent">
      <h1><span class="secnum">1.4.1</span>get Zone.prototype.parent<span class="utils"><span class="anchor"><a href="#sec-get-zone.prototype.parent">#</a></span></span></h1>

      <p><code>Zone.prototype.parent</code> is an accessor property whose set accessor function is <emu-val>undefined</emu-val>. Its get accessor function performs the following steps:</p>

      <emu-alg><ol><li>Let <var>Z</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>Z</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <var>Z</var> does not have a [[ParentZone]] internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>Return the value of <var>Z</var>'s [[ParentZone]] internal slot.
      </li></ol></emu-alg>
    </emu-clause>

    <emu-clause id="sec-zone.prototype.fork">
      <h1><span class="secnum">1.4.2</span>Zone.prototype.fork ( <var>options</var> )<span class="utils"><span class="anchor"><a href="#sec-zone.prototype.fork">#</a></span></span></h1>

      <p>When the <code>fork</code> method is called with argument <var>options</var>, the following steps are taken:</p>

      <emu-alg><ol><li>Let <var>Z</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>Z</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <var>Z</var> does not have a [[ParentZone]] internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>name</var> be <emu-val>null</emu-val>.</li><li>If <var>options</var> is <emu-val>undefined</emu-val>, set <var>options</var> to ! <emu-xref aoid="ObjectCreate"><a href="https://tc39.github.io/ecma262/#sec-objectcreate">ObjectCreate</a></emu-xref>(<emu-xref href="#sec-properties-of-the-object-prototype-object"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-object-prototype-object">%ObjectPrototype%</a></emu-xref>).</li><li>Perform ? <emu-xref aoid="RequireObjectCoercible"><a href="https://tc39.github.io/ecma262/#sec-requireobjectcoercible">RequireObjectCoercible</a></emu-xref>(<var>options</var>).</li><li>Let <var>nameOption</var> be ? <emu-xref aoid="GetV"><a href="https://tc39.github.io/ecma262/#sec-getv">GetV</a></emu-xref>(<var>options</var>, <code>"name"</code>).</li><li>If <var>nameOption</var> is <emu-val>undefined</emu-val>,<ol><li>Let <var>parentName</var> be ? <emu-xref aoid="ToString"><a href="https://tc39.github.io/ecma262/#sec-tostring">ToString</a></emu-xref>(? <emu-xref aoid="Get"><a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a></emu-xref>(<var>Z</var>, <code>"name"</code>)).</li><li>Set <var>name</var> to the result of concatenating <var>parentName</var> and the string <code>" child"</code>.</li></ol></li><li>Otherwise, set <var>name</var> to ? <emu-xref aoid="ToString"><a href="https://tc39.github.io/ecma262/#sec-tostring">ToString</a></emu-xref>(<var>nameOption</var>).</li><li>Let <var>constructorOptions</var> be ! <emu-xref aoid="ObjectCreate"><a href="https://tc39.github.io/ecma262/#sec-objectcreate">ObjectCreate</a></emu-xref>(<emu-xref href="#sec-properties-of-the-object-prototype-object"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-object-prototype-object">%ObjectPrototype%</a></emu-xref>).</li><li>Peform ! <emu-xref aoid="CreateDataProperty"><a href="https://tc39.github.io/ecma262/#sec-createdataproperty">CreateDataProperty</a></emu-xref>(<var>constructorOptions</var>, <code>"parent"</code>, <var>Z</var>).</li><li>Perform ! <emu-xref aoid="CreateDataProperty"><a href="https://tc39.github.io/ecma262/#sec-createdataproperty">CreateDataProperty</a></emu-xref>(<var>options</var>, <code>"name"</code>, <var>name</var>).</li><li>Let <var>C</var> be ? <emu-xref aoid="Get"><a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a></emu-xref>(<var>Z</var>, <code>"constructor"</code>).</li><li>Return ? <emu-xref aoid="Construct"><a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a></emu-xref>(<var>C</var>, « <var>options</var> »)
      </li></ol></emu-alg>

      <emu-note><span class="note">Note</span>
        <p>(Spec review note) This is intended to mimic the function signature <code>fork({ name = ToString(this.name) + " child" } = {}) { ... }</code>.</p>
      </emu-note>
    </emu-clause>

    <emu-clause id="sec-zone.prototype.run">
      <h1><span class="secnum">1.4.3</span>Zone.prototype.run ( <var>callback</var> )<span class="utils"><span class="anchor"><a href="#sec-zone.prototype.run">#</a></span></span></h1>

      <p>When the <code>run</code> method is called with argument <var>callback</var>, the following steps are taken:</p>

      <emu-alg><ol><li>Let <var>Z</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>Z</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <var>Z</var> does not have a [[ParentZone]] internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <emu-xref aoid="IsCallable"><a href="https://tc39.github.io/ecma262/#sec-iscallable">IsCallable</a></emu-xref>(<var>callback</var>) is <emu-val>false</emu-val>, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>C</var> be ? <emu-xref aoid="Get"><a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a></emu-xref>(<var>Z</var>, <code>"constructor")</code>.</li><li>If <emu-xref aoid="Type"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>C</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <var>C</var> does not have a [[CurrentZone]] internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>beforeZone</var> be the value of <var>C</var>'s [[CurrentZone]] internal slot.</li><li>Set <var>C</var>'s [[CurrentZone]] internal slot to <var>Z</var>.</li><li>Let <var>status</var> be <emu-xref aoid="Call"><a href="https://tc39.github.io/ecma262/#sec-call">Call</a></emu-xref>(<var>callback</var>, <emu-val>undefined</emu-val>, « »).</li><li>Set <var>C</var>'s [[CurrentZone]] internal slot to <var>beforeZone</var>.</li><li>Return <var>status</var>.
      </li></ol></emu-alg>
    </emu-clause>

    <emu-clause id="sec-zone.prototype.wrap">
      <h1><span class="secnum">1.4.4</span>Zone.prototype.wrap ( <var>callback</var> )<span class="utils"><span class="anchor"><a href="#sec-zone.prototype.wrap">#</a></span></span></h1>

      <p>When the <code>wrap</code> method is called with argument <var>callback</var>, the following steps are taken:</p>

      <emu-alg><ol><li>Let <var>Z</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>Z</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <var>Z</var> does not have a [[ParentZone]] internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>TODO
      </li></ol></emu-alg>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-zone-instances">
    <h1><span class="secnum">1.5</span>Properties of Zone Instances<span class="utils"><span class="anchor"><a href="#sec-properties-of-zone-instances">#</a></span></span></h1>
    <p>Zone instances are ordinary objects that inherit properties from the Zone prototype object (the intrinsic, <emu-xref href="#sec-properties-of-the-zone-prototype-object"><a href="#sec-properties-of-the-zone-prototype-object">%ZonePrototype%</a></emu-xref>). Zone instances are initially created with the internal slots described in  <emu-xref href="#table-zone-slots"><a href="#table-zone-slots">Table 2</a></emu-xref>.</p>

    <emu-table id="table-zone-slots" caption="Internal Slots of Zone Instances"><figure><figcaption>Table 2: Internal Slots of Zone Instances</figcaption>
      <table>
        <thead>
          <tr>
            <th>Internal Slot</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>[[ParentZone]]</td>
            <td>The zone in which this zone was created.</td>
          </tr>
        </tbody>
      </table>
    </figure></emu-table>

    <p>Each Zone instance has the following own property:</p>

    <emu-clause id="sec-properties-of-zone-instances-name">
      <h1><span class="secnum">1.5.1</span>name<span class="utils"><span class="anchor"><a href="#sec-properties-of-zone-instances-name">#</a></span></span></h1>

      <p>The value of the <code>name</code> property is an integer that indicates the name of the zone, supplied at construction time. It is used for debugging and tooling purposes and does not affect the zone's behavior.</p>

      <p>This property has the attributes { [[Writable]]: <emu-val>false</emu-val>, [[Enumerable]]: <emu-val>false</emu-val>, [[Configurable]]: <emu-val>true</emu-val> }.</p>
    </emu-clause>
  </emu-clause>
</emu-clause>

<emu-clause id="monkeypatch-promises">
  <h1><span class="secnum">2</span>Revisions to Promise Objects<span class="utils"><span class="anchor"><a href="#monkeypatch-promises">#</a></span></span></h1>

  <emu-clause id="monkeypatch-promisereaction-records">
    <h1><span class="secnum">2.1</span>PromiseReaction Records<span class="utils"><span class="anchor"><a href="#monkeypatch-promisereaction-records">#</a></span></span></h1>

    <p>TODO: add a field for the zone so we can store it.</p>
  </emu-clause>

  <emu-clause id="monkeypatch-perform-promise-then">
    <h1><span class="secnum">2.2</span>PerformPromiseThen<span class="utils"><span class="anchor"><a href="#monkeypatch-perform-promise-then">#</a></span></span></h1>

    <p>TODO: basically wrap the callbacks, except by storing the zone in the PromiseReaction instead of by generating a new function object.</p>
  </emu-clause>

  <emu-clause id="monkeypatch-promisereactionjob">
    <h1><span class="secnum">2.3</span>PromiseReactionJob<span class="utils"><span class="anchor"><a href="#monkeypatch-promisereactionjob">#</a></span></span></h1>

    <p>TODO: use stored field to set zone before running the handler (and of course restore the old zone afterward).</p>
  </emu-clause>
</emu-clause>
</body>